# Разработка программного обеспечения для организации полнотекстового поиска внутри корпоративной системы




# Getting start





# Документация

---

## Оглавление
1. **Конфигурация индекса**
2. **Настройка фильтров**
3. **Ранжирование результатов**
4. **Работа с API**
    - Добавление/обновление/удаление документов
    - Поиск
    - Фильтры и категории
5. **Примеры запросов**
6. **Обработка ошибок**

---

## 1. Конфигурация индекса
Индекс определяет структуру данных, по которым будет работать поиск. Конфиг описывает поля, их типы и возможности (поиск, фильтрация, сортировка).

### Формат JSON-конфига:
```json  
{
  "indexName": "example.shop",
  "category": ["Обувь", "Игрушки", "Женское", "Мужское"],
  "fields": [
    {
      "name": "title",
      "type": "string",
      "searchable": true
    },
    {
      "name": "price",
      "type": "number",
      "filterable": true,
      "sortable": true
    }
  ]
}
```  

### Поля:
- **`indexName`** (обязательно): Уникальное имя индекса.
- **`category`** (опционально): Список категорий для группировки данных.
- **`fields`** (обязательно): Массив полей с параметрами:
    - `name`: Название поля (должно соответствовать данным).
    - `type`: Тип данных (`string`, `number`, `bool`).
    - `searchable`: Разрешить поиск по этому полю.
    - `filterable`: Разрешить фильтрацию по полю.
    - `sortable`: Разрешить сортировку по полю.

> **Примечание**:
> - Поле `category` в индексе используется для привязки фильтров.
> - Если поле `filterable: true`, его нужно добавить в конфиг фильтров.

---

## 2. Настройка фильтров
Фильтры определяют, как пользователи могут сужать результаты поиска. Конфиг разделён по категориям.

### Формат JSON-конфига:
```json  
[
  {
    "category": "Обувь",
    "range": [
      {
        "name": "price",
        "type": "int",
        "from_value": "100",
        "to_value": "10000"
      }
    ],
    "multi-select": [
      {
        "name": "brand",
        "value": ["adidas", "nike"]
      }
    ],
    "one-select": [
      {
        "name": "sex",
        "value": ["unisex", "male"]
      }
    ],
    "bool-select": [
      {"name": "top-seller"}
    ]
  }
]
```  

### Типы фильтров:
- **`range`**: Диапазон значений (например, цена от 100 до 10000).
    - `type`: Тип данных (`int`, `float`).
    - `from_value`, `to_value`: Границы диапазона.
- **`multi-select`**: Множественный выбор значений (например, бренды).
- **`one-select`**: Выбор одного значения из списка (например, пол).
- **`bool-select`**: Булевый фильтр (например, "топ продавец").

> **Важно**:
> - Поле `name` в фильтрах должно совпадать с `name` в конфиге индекса.
> - Категория в фильтре должна быть объявлена в `category` индекса.

---

## 3. Ранжирование результатов
Ранжирование влияет на порядок выдачи результатов. Настройка весов и алгоритмов усиления.

### Формат JSON-конфига:
```json  
{
  "boosts": [
    {
      "field": "brand",
      "weight": 5,
      "boost_type": "catboostV2"
    }
  ]
}
```  

### Параметры:
- **`field`**: Поле, к которому применяется усиление.
- **`weight`**: Вес поля в итоговом ранжировании (чем выше, тем значимее).
- **`boost_type`**: Алгоритм усиления:
    - `logarithmic`: Логарифмическое усиление для текстовых полей.
    - `linear`: Линейное усиление для текстовых полей.


> **Важно**:
> - Последовательность в массиве `boosts` - влияет на приоритет усиления 

---

## 4. Работа с API

> **Важно**:
> - У всез запросов префикс `/api/v1`


### 4.1. Управление документами
- **Добавить документ**:
  ```http  
  POST /addDoc  
  Body: JSON-документ, соответствующий конфигу индекса.  
  ```  
  Пример:
  ```json  
  {
    "title": "Кроссовки Nike",
    "price": 5000,
    "brand": "nike"
  }
  ```  

- **Обновить документ**:
  ```http  
  POST /updateDoc?id={docId}  
  Body: Обновлённый JSON-документ.  
  ```  

- **Удалить документ**:
  ```http  
  DELETE /deleteDoc?id={docId}  
  ```  

- **Получить все документы**:
  ```http  
  GET /getAllDoc
  ```  

- **Получить документ по его docID**:
  ```http  
  GET /getDocId?docid={docId}  
  ```  

- **Получить структуру индекса**:
  ```http  
  GET /indexStruct
  ```  

- **Переиндексировать документы**:
  ```http  
  GET /reindex
  ```  
- **Пересобрать индекс**:
  ```http  
  GET /rebuild
  ```

### 4.2. Поиск
```http  
GET /search?query={текст запроса}&filters={JSON}&sortField={поле}&sortOrder={asc/desc}  
```  

- **Параметры**:
    - `query`: Поисковая строка.
    - `filters`: JSON-строка с фильтрами (см. раздел 2).
    - `sortField`: Поле для сортировки (должно быть `sortable: true`).
    - `sortOrder`: Порядок сортировки (`asc` или `desc`).

Пример запроса:
```  
/search?query=кроссовки&filters={"category":"Обувь","range":[{"name":"price","from_value":"2000","to_value":"8000"}]}&sortField=price&sortOrder=desc  
```  

### 4.3. Фильтры и категории
- **Получить все категории**:
  ```http  
  GET /category  
  ```  

- **Получить фильтры по категории**:
  ```http  
  GET /filtersByCategory?category=Обувь  
  ```  

### 4.4. Конфигурации
- **Получить конфигурацию**
  ```http  
  GET /getConfig/{configType}  
  ```  
  где `configType` = [index | filter | ranking]

- **обновить конфигурацию**
  ```http  
  POST /config/{configType}  
  ```  
  где `configType` = [index | filter | ranking]

- **Откатить конфигурацию индекса**
  ```http  
  GET /config/index/revert 
  ```
- **Проверка индекса на соответствие текущей версии конфигурации**
  ```http  
  GET /config/index/isbuild 
  ```  

### 4.4. Логи и метрики
- **Получение последнего лог-файла**
  ```http  
  GET /lastlog 
  ```  
- **Получение списка названий лог-файлов**
  ```http  
  GET /listlogs 
  ```  
- **Получение списка названий лог-файлов**
  ```http  
  GET /log?file={filename}
  ```  
  где `filename` - название лог-файла

- **Метрики prometheus**
  ```http  
  GET /metrics
  ```  
---

## 5. Интеграция с брокерами
Поддерживается подписка на события от NATS и Kafka. 
Подключение настраивается через .env. При получении события модуль парсит сообщение, валидирует и обновляет индекс. 
Операции логируются и метрики передаются в мониторинг.

```dotenv
NATS_URL=nats://127.0.0.1:4222 
NATS_SUBJECT=search_engine_updates 
ENABLE_NATS_SUBSCRIBER=true 

KAFKA_URL=kafka://127.0.0.1:9092
KAFKA_TOPIC=search_engine_updates
ENABLE_KAFKA_SUBSCRIBER=true
```

- **Формат принимаемого сообщения**
  Пример:
  ```json  
  {
    "docId": "id",
    "document": {
      "title": "Кроссовки Nike",
      "price": 5000,
      "brand": "nike"
    },
    "delete": false
  }
  ```  
- `docId` - необязательный параметр. Если имеется, документ либо обновляется, либо создается с заданным docid;
- `document` - документ формата определенного в конфигурации;
- `delete` - true/false - при true, документ с заданными docId удалится.


---

## 6. Обработка ошибок
- **400 Bad Request**: Невалидный JSON, несоответствие конфигу.
- **404 Not Found**: Документ или категория не найдены.
- **500 Internal Server Error**: Ошибка на сервере (проверьте логи).

---

**Примечание для разработчиков**:
[Рекомендация по интеграции сервиса](INTEGRATION_RECOMMENDATION.md)
